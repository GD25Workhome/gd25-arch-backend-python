# 模版同步指南

## 一、为什么需要同步模版？

本项目是一个 **CookieCutter 模版工程**，包含两个部分：

1. **项目代码**（`app/`, `tests/`, `scripts/` 等）- 实际运行的项目代码
2. **模版代码**（`cookiecutter-gd25-arch-backend-python/`）- 用于生成新项目的模版

当你修改了项目代码后，需要将这些修改同步到模版中，这样：
- ✅ 新生成的项目会包含最新的代码
- ✅ 模版保持与项目代码一致
- ✅ 避免模版过时

## 二、什么时候需要同步模版？

### 2.1 必须同步的情况

以下情况**必须**同步模版：

1. **修改了 `app/` 目录下的代码**
   - 修改了模型、Schema、Repository、Service、API 等
   - 添加了新的功能模块
   - 修改了代码结构或命名规范

2. **修改了配置文件**
   - `requirements.txt` / `requirements-dev.txt`
   - `pyproject.toml`
   - `pytest.ini`
   - `alembic.ini`

3. **修改了脚本文件**
   - `scripts/` 目录下的脚本

4. **修改了测试文件**
   - `tests/` 目录下的测试代码

5. **修改了数据库迁移配置**
   - `alembic/` 目录下的配置

### 2.2 不需要同步的情况

以下情况**不需要**同步模版：

1. **项目特定的配置**
   - `.env` 文件（环境变量）
   - 数据库迁移文件（`alembic/versions/*.py`）
   - 项目特定的文档

2. **开发工具配置**
   - `.gitignore`
   - IDE 配置文件（`.vscode/`, `.idea/`）
   - 临时文件（`__pycache__/`, `*.pyc`）

3. **项目文档**
   - `docs/` 目录（模版有自己的文档）
   - `README.md`（模版有自己的 README）

## 三、同步模版的快捷方式

### 3.1 使用同步脚本（推荐）

我们提供了一个自动化同步脚本：

```bash
# 方式一：试运行（查看将要执行的操作，不实际执行）
python scripts/sync_template.py --dry-run

# 方式二：实际执行同步
python scripts/sync_template.py

# 方式三：显示详细信息
python scripts/sync_template.py --verbose
```

**脚本功能：**
- ✅ 自动同步 `app/` 目录下的所有代码
- ✅ 同步配置文件（requirements.txt, pyproject.toml 等）
- ✅ 自动处理文件重命名、删除、新增
- ✅ 排除不需要同步的文件（.env, __pycache__ 等）
- ✅ 支持试运行模式，安全预览操作

### 3.2 手动同步（不推荐）

如果脚本无法满足需求，可以手动同步：

```bash
# 1. 同步 app 目录
cp -r app/* cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/app/

# 2. 同步配置文件
cp requirements.txt cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/
cp pyproject.toml cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/

# 3. 同步其他目录
cp -r tests/* cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/tests/
cp -r scripts/* cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/scripts/
```

**注意：** 手动同步容易遗漏文件，建议使用脚本。

## 四、常见场景处理

### 4.1 场景一：重命名文件

**问题：** 我重命名了 `app/models/user.py` 为 `app/models/user_model.py`，同步模版会出错吗？

**答案：** 不会！同步脚本会自动处理：
- ✅ 复制新文件 `user_model.py` 到模版
- ✅ 删除模版中的旧文件 `user.py`
- ✅ 更新所有引用该文件的地方（需要手动检查）

**操作步骤：**
```bash
# 1. 在项目代码中重命名文件并更新所有引用
# 2. 运行同步脚本
python scripts/sync_template.py --dry-run  # 先预览
python scripts/sync_template.py             # 实际执行
# 3. 检查模版中的引用是否都已更新
```

### 4.2 场景二：删除文件

**问题：** 我删除了 `app/utils/old_util.py`，同步模版会出错吗？

**答案：** 不会！同步脚本会自动：
- ✅ 检测到源文件中不存在该文件
- ✅ 自动删除模版中的对应文件

**操作步骤：**
```bash
# 1. 在项目代码中删除文件
# 2. 运行同步脚本
python scripts/sync_template.py
# 模版中的文件会被自动删除
```

### 4.3 场景三：新增文件

**问题：** 我新增了 `app/models/product_model.py`，同步模版会出错吗？

**答案：** 不会！同步脚本会自动：
- ✅ 检测到新文件
- ✅ 自动复制到模版

**操作步骤：**
```bash
# 1. 在项目代码中创建新文件
# 2. 运行同步脚本
python scripts/sync_template.py
# 新文件会被自动复制到模版
```

### 4.4 场景四：修改文件内容

**问题：** 我修改了 `app/services/user_service.py` 的内容，同步模版会出错吗？

**答案：** 不会！同步脚本会：
- ✅ 直接覆盖模版中的文件
- ✅ 保留模版中的 CookieCutter 变量（如果有）

**操作步骤：**
```bash
# 1. 在项目代码中修改文件
# 2. 运行同步脚本
python scripts/sync_template.py
# 模版中的文件会被更新
```

### 4.5 场景五：修改了导入路径

**问题：** 我修改了文件中的导入语句（如 `from app.models.user import` 改为 `from app.models.user_model import`），同步模版会出错吗？

**答案：** 不会！同步脚本会：
- ✅ 直接覆盖文件内容，包括新的导入语句
- ⚠️ 但需要确保所有相关文件都已同步

**操作步骤：**
```bash
# 1. 在项目代码中修改所有相关文件的导入语句
# 2. 运行同步脚本（会同步所有修改的文件）
python scripts/sync_template.py
# 3. 验证模版中的导入是否正确
```

## 五、同步后验证

### 5.1 检查同步结果

同步完成后，建议检查：

```bash
# 1. 检查模版目录结构
ls -la cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/app/

# 2. 检查关键文件是否存在
ls cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/app/models/
ls cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/app/schemas/

# 3. 检查文件内容是否正确
cat cookiecutter-gd25-arch-backend-python/{{\ cookiecutter.project_name\ }}/app/models/user_model.py
```

### 5.2 测试模版生成

同步后，建议测试模版是否能正常生成项目：

```bash
# 1. 使用模版生成测试项目
cookiecutter cookiecutter-gd25-arch-backend-python --no-input \
  --overwrite-if-exists \
  project_name=test-project

# 2. 进入生成的项目
cd test-project

# 3. 检查生成的文件是否正确
ls app/models/
ls app/schemas/

# 4. 检查导入是否正常
python -c "from app.models.user_model import User; print('OK')"
python -c "from app.schemas.user_schema import UserCreate; print('OK')"

# 5. 清理测试项目
cd ..
rm -rf test-project
```

## 六、注意事项

### 6.1 模版变量

模版中可能包含 CookieCutter 变量（如 `{{ cookiecutter.project_name }}`），同步时：
- ✅ 脚本会保留这些变量
- ⚠️ 不要手动修改包含变量的文件，除非你知道自己在做什么

### 6.2 文件路径

模版目录中的路径包含特殊字符（`{{ cookiecutter.project_name }}`），在命令行中使用时需要转义：

```bash
# 正确
ls "cookiecutter-gd25-arch-backend-python/{{ cookiecutter.project_name }}/app/"

# 或者使用转义
ls cookiecutter-gd25-arch-backend-python/\{\{\ cookiecutter.project_name\ \}\}/app/
```

### 6.3 Git 提交

同步模版后，记得提交更改：

```bash
# 1. 查看更改
git status

# 2. 添加模版目录的更改
git add cookiecutter-gd25-arch-backend-python/

# 3. 提交
git commit -m "同步模版：更新用户模型和 Schema 命名规范"
```

### 6.4 冲突处理

如果模版中有手动修改的内容与项目代码冲突：
1. 先查看冲突内容
2. 决定保留哪个版本
3. 手动合并或选择保留

## 七、最佳实践

### 7.1 同步流程

推荐的同步流程：

```bash
# 1. 在项目代码中完成修改
# 2. 测试项目代码是否正常工作
# 3. 运行同步脚本（先试运行）
python scripts/sync_template.py --dry-run

# 4. 检查预览结果，确认无误
# 5. 实际执行同步
python scripts/sync_template.py

# 6. 验证模版
cookiecutter cookiecutter-gd25-arch-backend-python --no-input \
  --overwrite-if-exists project_name=test-project
cd test-project
python -c "from app.models.user_model import User; print('OK')"
cd ..
rm -rf test-project

# 7. 提交更改
git add cookiecutter-gd25-arch-backend-python/
git commit -m "同步模版：描述你的更改"
```

### 7.2 定期同步

建议：
- ✅ 每次修改项目代码后立即同步模版
- ✅ 提交代码前同步模版
- ✅ 发布新版本前同步模版

### 7.3 版本控制

建议：
- ✅ 将模版目录纳入 Git 版本控制
- ✅ 同步模版后立即提交
- ✅ 在提交信息中说明同步的内容

## 八、故障排查

### 8.1 同步脚本无法运行

**问题：** `python scripts/sync_template.py` 报错

**解决：**
```bash
# 1. 检查 Python 版本（需要 Python 3.7+）
python --version

# 2. 检查脚本权限
chmod +x scripts/sync_template.py

# 3. 检查路径是否正确
pwd  # 应该在项目根目录
```

### 8.2 模版目录不存在

**问题：** 提示模版目录不存在

**解决：**
```bash
# 检查模版目录是否存在
ls -la cookiecutter-gd25-arch-backend-python/

# 如果不存在，需要先创建模版结构
# 参考 CookieCutter 使用指南
```

### 8.3 文件同步失败

**问题：** 某些文件同步失败

**解决：**
```bash
# 1. 检查文件权限
ls -la app/models/user_model.py

# 2. 检查磁盘空间
df -h

# 3. 使用详细模式查看错误
python scripts/sync_template.py --verbose
```

## 九、总结

- ✅ **必须同步**：修改了 `app/`、配置文件、脚本、测试等
- ✅ **推荐方式**：使用 `scripts/sync_template.py` 脚本
- ✅ **同步前**：先试运行查看预览
- ✅ **同步后**：验证模版生成是否正常
- ✅ **提交前**：确保模版已同步并提交

通过遵循本指南，可以确保模版始终与项目代码保持同步！
