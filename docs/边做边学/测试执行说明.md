# 测试执行说明

## 为什么直接执行 `python tests/test_main.py` 没有输出？

### 问题原因

`tests/test_main.py` 是一个 **pytest 测试文件**，不是普通的 Python 脚本。它：

1. ❌ **没有 `if __name__ == "__main__"` 块**：直接执行不会运行任何代码
2. ❌ **没有可执行代码**：文件只包含测试函数定义，需要 pytest 来发现和执行
3. ✅ **需要使用 pytest 运行**：pytest 会自动发现并执行以 `test_` 开头的函数

### 文件结构

```python
# tests/test_main.py
import pytest
from fastapi.testclient import TestClient

# 这些是测试函数，不会自动执行
def test_health_check(client):
    """测试健康检查接口"""
    response = client.get("/health")
    assert response.status_code == 200
    # ...

# 没有这段代码，所以直接执行不会有输出：
# if __name__ == "__main__":
#     pytest.main([__file__])
```

## 正确的执行方式

### 方式一：使用 pytest 命令（推荐）

```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_main.py

# 运行特定测试函数
pytest tests/test_main.py::test_health_check

# 显示详细输出
pytest tests/test_main.py -v

# 显示更详细的输出（包括打印语句）
pytest tests/test_main.py -v -s
```

### 方式二：使用 Python 模块方式

```bash
# 运行所有测试
python -m pytest

# 运行特定测试文件
python -m pytest tests/test_main.py

# 显示详细输出
python -m pytest tests/test_main.py -v
```

### 方式三：临时修复 pytest.ini 配置问题

如果遇到 coverage 相关错误，可以临时禁用：

```bash
# 方法 1：使用 -o 参数覆盖配置
python -m pytest tests/test_main.py -v -o addopts=

# 方法 2：安装 pytest-cov
pip install pytest-cov

# 方法 3：修改 pytest.ini，注释掉 coverage 相关配置
```

## 常见问题

### Q1: 为什么 `python tests/test_main.py` 没有输出？

**A:** 因为文件没有可执行代码。测试文件需要 pytest 来发现和执行测试函数。

**解决方案：**
```bash
# 使用 pytest 运行
pytest tests/test_main.py -v
```

### Q2: 如何让测试文件可以直接执行？

**A:** 测试文件已经支持直接执行！在文件末尾已经添加了：

```python
# tests/test_main.py
# ... 测试代码 ...

if __name__ == "__main__":
    import pytest
    import sys
    exit_code = pytest.main([
        __file__,
        "-v",           # 详细输出
        "-s",           # 显示打印语句
        "-o", "addopts=",  # 忽略 pytest.ini 中的 addopts 配置
    ])
    sys.exit(exit_code)
```

现在可以直接执行：
```bash
python tests/test_main.py
```

**注意：** 推荐使用 `pytest` 命令，直接执行主要用于快速测试。

### Q3: 如何查看测试输出？

**A:** 使用 `-v`（详细）和 `-s`（显示打印）参数：

```bash
# 详细输出
pytest tests/test_main.py -v

# 显示打印语句
pytest tests/test_main.py -v -s

# 显示最详细的输出
pytest tests/test_main.py -vv -s
```

### Q4: 如何只运行特定的测试？

**A:** 使用多种方式：

```bash
# 运行特定函数
pytest tests/test_main.py::test_health_check

# 运行包含特定字符串的测试
pytest -k "health"

# 运行标记的测试
pytest -m unit
```

### Q5: 如何查看测试覆盖率？

**A:** 需要安装 pytest-cov：

```bash
# 安装
pip install pytest-cov

# 运行并生成覆盖率报告
pytest --cov=app --cov-report=html

# 查看 HTML 报告
open htmlcov/index.html
```

## 执行示例

### 示例 1：运行所有测试

```bash
$ pytest tests/test_main.py -v

============================= test session starts ==============================
platform darwin -- Python 3.9.23, pytest-8.4.2
collected 21 items

tests/test_main.py::test_app_configuration PASSED                        [  4%]
tests/test_main.py::test_app_docs_url PASSED                             [  9%]
tests/test_main.py::test_health_check PASSED                             [ 14%]
...
============================= 21 passed in 0.62s ==============================
```

### 示例 2：运行特定测试

```bash
$ pytest tests/test_main.py::test_health_check -v

============================= test session starts ==============================
collected 1 item

tests/test_main.py::test_health_check PASSED                        [100%]

============================= 1 passed in 0.15s ==============================
```

### 示例 3：显示详细输出和打印

```bash
$ pytest tests/test_main.py -v -s

============================= test session starts ==============================
tests/test_main.py::test_health_check 
-------------------------------- live log call ---------------------------------
2025-12-03 16:20:59 [    INFO] sqlalchemy.engine.Engine: BEGIN (implicit)
2025-12-03 16:20:59 [    INFO] sqlalchemy.engine.Engine: SELECT 1
PASSED                                                                   [  4%]
...
```

## 最佳实践

### 1. 开发时快速测试

```bash
# 运行特定测试，显示详细输出
pytest tests/test_main.py::test_health_check -v -s
```

### 2. 运行所有测试

```bash
# 运行所有测试
pytest

# 或指定目录
pytest tests/
```

### 3. 持续集成（CI）

```bash
# 运行所有测试，生成覆盖率报告
pytest --cov=app --cov-report=xml --cov-report=term
```

### 4. 调试测试

```bash
# 使用 pdb 调试
pytest tests/test_main.py::test_health_check --pdb

# 在第一个失败时停止
pytest tests/test_main.py -x
```

## 总结

**关键点：**
1. ✅ 测试文件需要使用 `pytest` 命令运行
2. ✅ 直接执行 `python tests/test_main.py` 不会有输出
3. ✅ 使用 `-v` 参数查看详细输出
4. ✅ 使用 `-s` 参数查看打印语句

**推荐命令：**
```bash
# 开发时
pytest tests/test_main.py -v -s

# 快速测试
pytest tests/test_main.py::test_health_check -v

# 完整测试
pytest tests/ -v
```

