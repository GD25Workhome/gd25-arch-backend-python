# 数据库初始化使用说明

本文档介绍如何使用数据库初始化脚本自动创建数据库和安装 PostgreSQL 向量扩展。

## 一、功能概述

数据库初始化脚本 (`scripts/init_db.py`) 提供以下功能：

1. **自动创建数据库**：如果数据库不存在，自动创建
2. **验证数据库连接**：确保数据库连接配置正确
3. **安装 pgvector 扩展**（可选）：为 PostgreSQL 数据库安装向量扩展

## 二、前置要求

1. **数据库服务器已启动**
   - PostgreSQL 14+ 或 MySQL 8.0+
   - 确保数据库服务正在运行

2. **配置数据库连接**
   - 在 `.env` 文件中配置 `DATABASE_URL`
   - 或设置环境变量 `DATABASE_URL`

3. **数据库用户权限**
   - 创建数据库需要足够的权限
   - 安装 pgvector 扩展需要超级用户或数据库所有者权限

## 三、使用方法

### 3.1 基本使用

```bash
# 创建数据库（如果不存在）并验证连接
python scripts/init_db.py
```

### 3.2 安装 pgvector 扩展（仅 PostgreSQL）

```bash
# 创建数据库并安装 pgvector 扩展
python scripts/init_db.py --install-pgvector
```

### 3.3 查看帮助信息

```bash
python scripts/init_db.py --help
```

## 四、配置说明

### 4.1 数据库 URL 格式

**PostgreSQL:**
```
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
```

**MySQL:**
```
DATABASE_URL=mysql+pymysql://user:password@localhost:3306/dbname
```

### 4.2 环境变量配置

在 `.env` 文件中配置：

```bash
# .env
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
```

或使用环境变量：

```bash
export DATABASE_URL=postgresql://user:password@localhost:5432/mydb
python scripts/init_db.py
```

## 五、功能详解

### 5.1 数据库创建

脚本会：

1. **连接到数据库服务器**（而非特定数据库）
   - PostgreSQL: 连接到 `postgres` 数据库
   - MySQL: 连接到 `mysql` 数据库

2. **检查数据库是否存在**
   - 如果已存在，跳过创建步骤
   - 如果不存在，自动创建

3. **处理错误情况**
   - 权限不足：提示用户检查权限
   - 连接失败：提示检查服务器状态和连接信息

### 5.2 连接验证

创建数据库后，脚本会：

1. 连接到新创建的数据库
2. 执行简单查询验证连接
3. 如果验证失败，提供错误信息

### 5.3 pgvector 扩展安装

**仅支持 PostgreSQL 数据库**

安装步骤：

1. **检查扩展是否已安装**
   - 如果已安装，跳过安装步骤

2. **安装扩展**
   - 执行 `CREATE EXTENSION IF NOT EXISTS vector`
   - 需要超级用户或数据库所有者权限

3. **验证安装**
   - 检查扩展是否成功安装

**注意事项：**

- pgvector 扩展需要先在 PostgreSQL 服务器上安装
- Ubuntu/Debian: `sudo apt-get install postgresql-14-pgvector`
- 或从源码编译安装: https://github.com/pgvector/pgvector
- 如果用户没有安装扩展的权限，脚本会提示错误信息

## 六、使用场景

### 6.1 新项目初始化

```bash
# 1. 配置 .env 文件
echo "DATABASE_URL=postgresql://user:password@localhost:5432/mydb" > .env

# 2. 初始化数据库
python scripts/init_db.py

# 3. 运行数据库迁移
alembic upgrade head

# 4. 启动应用
uvicorn app.main:app --reload
```

### 6.2 需要向量搜索功能

```bash
# 1. 确保 PostgreSQL 服务器已安装 pgvector 扩展
# Ubuntu/Debian:
sudo apt-get install postgresql-14-pgvector

# 2. 初始化数据库并安装扩展
python scripts/init_db.py --install-pgvector

# 3. 运行数据库迁移
alembic upgrade head
```

### 6.3 开发环境快速设置

```bash
# 一键初始化（假设已配置 .env）
python scripts/init_db.py && alembic upgrade head
```

## 七、错误处理

### 7.1 常见错误

**错误 1: 数据库连接失败**

```
✗ 数据库连接失败: ...
  请检查：
  1. 数据库服务器是否已启动
  2. 连接信息是否正确（用户名、密码、主机、端口）
  3. 用户是否有创建数据库的权限
```

**解决方案：**
- 检查数据库服务是否运行：`sudo systemctl status postgresql`
- 验证连接信息是否正确
- 检查用户权限

**错误 2: 创建数据库失败（权限不足）**

```
✗ 创建数据库失败: permission denied
```

**解决方案：**
- 使用具有创建数据库权限的用户
- PostgreSQL: 使用 `postgres` 超级用户
- MySQL: 使用 `root` 用户或具有 `CREATE DATABASE` 权限的用户

**错误 3: pgvector 扩展安装失败**

```
✗ 安装 pgvector 扩展失败: permission denied
```

**解决方案：**
- 确保 PostgreSQL 服务器已安装 pgvector 扩展
- 使用超级用户或数据库所有者权限运行脚本
- 或手动安装扩展：`psql -U postgres -d mydb -c "CREATE EXTENSION vector"`

### 7.2 调试技巧

1. **启用调试模式**
   - 在 `.env` 中设置 `DEBUG=true`
   - 查看详细的错误信息

2. **手动测试连接**
   ```bash
   # PostgreSQL
   psql -U user -h localhost -p 5432 -d postgres
   
   # MySQL
   mysql -u user -h localhost -P 3306 -p
   ```

3. **检查数据库是否存在**
   ```sql
   -- PostgreSQL
   SELECT datname FROM pg_database WHERE datname = 'mydb';
   
   -- MySQL
   SHOW DATABASES LIKE 'mydb';
   ```

## 八、与 CookieCutter 集成

如果使用 CookieCutter 模板生成项目，可以在生成时选择是否安装 pgvector 扩展：

```bash
cookiecutter cookiecutter-gd25-arch-backend-python
```

在交互式提示中：
- `install_pgvector`: 选择 `y` 或 `n`

生成项目后，根据提示运行数据库初始化脚本。

## 九、最佳实践

1. **开发环境**
   - 使用数据库初始化脚本自动创建数据库
   - 简化开发环境设置流程

2. **生产环境**
   - 建议手动创建数据库，确保权限和配置正确
   - 使用数据库初始化脚本作为验证工具

3. **CI/CD 流程**
   - 在 CI 环境中使用脚本自动初始化测试数据库
   - 确保测试环境一致性

## 十、相关文档

- [快速开始指南](./快速开始指南.md)
- [开发计划](../开发计划.md)
- [pgvector 官方文档](https://github.com/pgvector/pgvector)

---

**提示：** 如果遇到问题，请查看脚本输出的详细错误信息，或参考本文档的错误处理部分。
