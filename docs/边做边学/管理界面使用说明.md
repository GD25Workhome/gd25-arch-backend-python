# 管理界面使用说明

## 概述

管理界面是一个简单的 Web 界面，用于管理系统核心功能，包括：

- ✅ 系统概览（健康状态、统计信息）
- ✅ 用户管理（查看、搜索、删除用户）
- ✅ 系统信息（配置信息、版本信息）
- ✅ 数据库信息（连接状态、统计信息）

## 访问方式

### 开发环境

1. 启动应用：
   ```bash
   uvicorn app.main:app --reload
   ```

2. 访问管理界面：
   ```
   http://localhost:8100/admin
   ```

### 生产环境

在生产环境中，建议：
- 配置反向代理（如 Nginx）
- 添加身份认证（建议实现）
- 限制访问 IP（建议配置）

## 功能说明

### 1. 系统概览

显示系统整体状态：

- **系统健康状态**：显示系统和数据库的连接状态
- **用户统计**：显示用户总数和活跃用户数
- **数据库状态**：显示数据库连接状态
- **运行环境**：显示当前运行环境（development/testing/production）

### 2. 用户管理

提供用户管理功能：

- **用户列表**：分页显示所有用户
- **搜索功能**：根据关键词搜索用户
- **删除用户**：删除指定用户（需要确认）

**注意**：用户管理功能基于现有的用户 API，需要确保用户 API 已正确注册。

### 3. 系统信息

显示系统配置信息：

- **基本信息**：应用名称、版本、环境、调试模式等
- **配置信息**：数据库 URL、Redis URL、Celery 配置等（敏感信息已隐藏）

### 4. 数据库信息

显示数据库相关信息：

- **连接状态**：数据库连接状态和错误信息
- **统计信息**：数据库类型、表数量等

## API 接口

管理界面使用以下 API 接口：

### 系统相关

- `GET /api/v1/admin/system/info` - 获取系统信息
- `GET /api/v1/admin/system/health` - 获取系统健康状态
- `GET /api/v1/admin/config/info` - 获取配置信息（只读）

### 数据库相关

- `GET /api/v1/admin/database/stats` - 获取数据库统计信息

### 统计相关

- `GET /api/v1/admin/stats/overview` - 获取系统概览统计

### 用户相关（使用现有 API）

- `GET /api/v1/users` - 获取用户列表
- `GET /api/v1/users/search` - 搜索用户
- `DELETE /api/v1/users/{user_id}` - 删除用户

## 安全建议

### 1. 身份认证

当前管理界面**没有身份认证**，建议在生产环境中添加：

**方案一：使用 FastAPI 的依赖注入添加认证**

```python
# app/dependencies.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBasic, HTTPBasicCredentials

security = HTTPBasic()

def verify_admin(credentials: HTTPBasicCredentials = Depends(security)):
    """验证管理员身份"""
    # 这里可以实现你的认证逻辑
    if credentials.username != "admin" or credentials.password != "your_password":
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="身份验证失败",
            headers={"WWW-Authenticate": "Basic"},
        )
    return credentials.username

# app/api/admin.py
@router.get("/system/info")
async def get_system_info(
    admin: str = Depends(verify_admin)  # 添加认证依赖
):
    # ...
```

**方案二：使用 JWT Token**

```python
# 在管理界面中添加 Token 认证
# 前端在请求头中添加：Authorization: Bearer <token>
```

### 2. IP 白名单

限制管理界面的访问 IP：

```python
# app/main.py
from fastapi import Request, status
from fastapi.responses import JSONResponse

ALLOWED_IPS = ["127.0.0.1", "192.168.1.0/24"]  # 配置允许的 IP

@app.middleware("http")
async def admin_ip_whitelist(request: Request, call_next):
    """管理界面 IP 白名单"""
    if request.url.path.startswith("/admin") or request.url.path.startswith("/api/v1/admin"):
        client_ip = request.client.host
        # 检查 IP 是否在白名单中
        if not is_ip_allowed(client_ip, ALLOWED_IPS):
            return JSONResponse(
                status_code=status.HTTP_403_FORBIDDEN,
                content={"message": "访问被拒绝"}
            )
    return await call_next(request)
```

### 3. HTTPS

在生产环境中，建议使用 HTTPS 来保护管理界面：

```bash
# 使用 uvicorn 启动 HTTPS
uvicorn app.main:app --ssl-keyfile key.pem --ssl-certfile cert.pem
```

### 4. 日志记录

管理界面的所有操作都应该记录日志：

```python
# app/api/admin.py
import logging

logger = logging.getLogger(__name__)

@router.delete("/users/{user_id}")
async def delete_user(user_id: int, admin: str = Depends(verify_admin)):
    logger.info(f"管理员 {admin} 删除了用户 {user_id}")
    # ...
```

## 自定义扩展

### 添加新的管理功能

1. **添加新的 API 路由**：

```python
# app/api/admin.py
@router.get("/custom/stats")
async def get_custom_stats():
    # 实现自定义统计逻辑
    pass
```

2. **在前端添加新页面**：

```html
<!-- app/static/admin/index.html -->
<div id="page-custom" class="page">
    <h2>自定义功能</h2>
    <!-- 添加内容 -->
</div>
```

```javascript
// app/static/admin/app.js
function loadCustomPage() {
    // 加载自定义页面数据
}
```

### 修改样式

编辑 `app/static/admin/style.css` 来自定义样式。

### 修改布局

编辑 `app/static/admin/index.html` 来修改页面布局。

## 故障排查

### 1. 管理界面无法访问

- 检查应用是否正常启动
- 检查静态文件目录是否存在：`app/static/admin/`
- 检查路由是否正确注册

### 2. API 请求失败

- 检查浏览器控制台的错误信息
- 检查 API 路由是否正确注册
- 检查 CORS 配置是否正确

### 3. 数据不显示

- 检查数据库连接是否正常
- 检查 API 返回的数据格式是否正确
- 检查浏览器控制台的网络请求

## 技术栈

- **前端**：原生 HTML/CSS/JavaScript（无框架依赖）
- **后端**：FastAPI
- **API**：RESTful API

## 文件结构

```
app/
├── static/
│   └── admin/
│       ├── index.html      # 管理界面 HTML
│       ├── style.css       # 样式文件
│       └── app.js          # 前端逻辑
├── api/
│   └── admin.py            # 管理后台 API 路由
└── main.py                 # 主应用（注册路由和静态文件服务）
```

## 总结

管理界面提供了一个简单、实用的方式来管理系统核心功能。虽然当前版本没有身份认证，但提供了清晰的扩展点，可以根据项目需求添加认证、权限控制等功能。

**建议**：
- 开发环境：可以直接使用，方便快速查看系统状态
- 生产环境：必须添加身份认证和访问控制
