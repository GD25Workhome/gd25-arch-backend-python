# FastAPI 后端脚手架 - 开发计划

## 一、项目概述

### 1.1 项目目标

开发一个通用的 FastAPI 后端脚手架，为团队提供标准化的项目基础框架，包含：
- 标准化的项目结构
- 通用的基础设施代码
- 最佳实践和约定
- 可复用的工具类

### 1.2 核心价值

- ✅ **快速启动新项目**：避免重复搭建基础框架
- ✅ **统一代码风格**：团队使用相同的项目结构
- ✅ **减少重复工作**：基础设施代码一次编写，多次使用
- ✅ **提高开发效率**：专注于业务逻辑，而不是基础设施

### 1.3 技术栈

```
技术栈：
├── FastAPI              # Web 框架
├── SQLAlchemy           # ORM 框架
├── Alembic              # 数据库迁移
├── Pydantic             # 数据验证
├── Celery               # 异步任务队列（可选）
├── Redis                # 缓存和消息队列（可选）
└── PostgreSQL/MySQL     # 数据库支持
```

---

## 二、开发原则

### 2.1 设计原则

- **通用性优先**：只包含通用的基础设施代码
- **业务无关**：不包含任何业务逻辑
- **可扩展性**：提供扩展点，允许项目自定义
- **可选模块**：通过参数控制是否包含可选功能

### 2.2 代码规范

- 使用详细的简体中文注释和文档字符串
- 函数和类必须有完整的类型提示
- 异常处理要完善，提供有用的错误信息
- 遵循 PEP 8 代码风格

---

## 三、里程碑划分

### 里程碑 1：项目基础结构（2-3 天）

**目标**：完成项目基础结构搭建，包括目录结构、配置文件、基础依赖等。

#### 任务清单

1. **项目初始化**
   - [x] 创建项目目录结构
   - [x] 初始化 Git 仓库（已存在）
   - [x] 创建 `requirements.txt` 和 `requirements-dev.txt`
   - [x] 创建 `.env.example`
   - [x] 创建 `.gitignore`
   - [x] 创建 `README.md`（使用说明）

2. **基础目录结构**
   - [x] 创建 `app/` 目录结构
   - [x] 创建 `app/api/` 目录（空结构）
   - [x] 创建 `app/services/` 目录（空结构）
   - [x] 创建 `app/models/` 目录（空结构）
   - [x] 创建 `app/schemas/` 目录（空结构）
   - [x] 创建 `app/repositories/` 目录（空结构）
   - [x] 创建 `app/db/` 目录
   - [x] 创建 `app/utils/` 目录
   - [x] 创建 `tests/` 目录

3. **基础配置文件**
   - [x] 创建 `pytest.ini`（测试配置）
   - [x] 创建 `alembic.ini`（数据库迁移配置）
   - [x] 创建 `pyproject.toml`（可选，用于项目元数据）

#### 验收标准

- [x] 项目目录结构完整
- [x] 所有配置文件创建完成
- [x] Git 仓库初始化完成
- [x] README 文档包含使用说明

---

### 里程碑 2：配置管理模块（1-2 天）

**目标**：完成配置管理模块，支持环境变量管理和配置验证。

#### 任务清单

1. **配置管理实现**
   - [x] 实现 `app/config.py`（配置管理）
   - [x] 使用 Pydantic Settings 进行配置验证
   - [x] 支持环境变量读取
   - [x] 支持 `.env` 文件加载
   - [x] 实现多环境配置（开发/测试/生产）

2. **配置项定义**
   - [x] 应用配置（app_name, app_version, debug）
   - [x] 数据库配置（database_url）
   - [x] Redis 配置（redis_url，可选）
   - [x] Celery 配置（celery_broker_url, celery_result_backend，可选）
   - [x] 日志配置（log_level, log_format）
   - [x] CORS 配置（cors_origins）

3. **配置扩展点**
   - [x] 提供配置扩展机制，允许项目添加自定义配置项
   - [x] 实现配置验证逻辑

#### 验收标准

- [x] 配置可以正常加载
- [x] 环境变量可以正常读取
- [x] 配置验证正常工作
- [x] 支持配置扩展

#### 测试验证

```python
# 测试配置加载
from app.config import settings

assert settings.app_name is not None
assert settings.database_url is not None
print(f"App name: {settings.app_name}")
print(f"Database URL: {settings.database_url}")
```

---

### 里程碑 3：数据库基础模块（2-3 天）

**目标**：完成数据库连接、基础模型、会话管理等基础功能。

#### 任务清单

1. **数据库连接**
   - [x] 实现 `app/db/database.py`（数据库连接）
   - [x] 配置 SQLAlchemy Engine
   - [x] 配置连接池（pool_size, max_overflow）
   - [x] 实现连接健康检查（pool_pre_ping）

2. **基础模型**
   - [x] 实现 `app/db/base.py`（基础模型类）
   - [x] 定义 BaseModel（包含 id, created_at, updated_at）
   - [x] 实现 DeclarativeBase

3. **会话管理**
   - [x] 实现 `app/db/session.py`（会话管理）
   - [x] 实现 SessionLocal（sessionmaker）
   - [x] 实现 `get_db()` 依赖注入函数
   - [x] 实现数据库会话上下文管理

4. **Alembic 配置**
   - [x] 配置 `alembic/env.py`
   - [x] 配置数据库迁移脚本模板
   - [x] 创建初始迁移脚本示例（README 和目录结构）

#### 验收标准

- [x] 数据库连接正常
- [x] 基础模型可以正常使用
- [x] 数据库会话管理正常
- [x] Alembic 配置完成

#### 测试验证

```python
# 测试数据库连接
from app.db.database import engine, SessionLocal
from app.db.base import Base

# 测试连接
with engine.connect() as conn:
    result = conn.execute(text("SELECT 1"))
    assert result.scalar() == 1

# 测试会话
db = SessionLocal()
try:
    # 测试查询
    result = db.execute(text("SELECT 1"))
    assert result.scalar() == 1
finally:
    db.close()
```

---

### 里程碑 4：工具类模块（1-2 天）

**目标**：完成日志工具、ID 生成器等通用工具类。

#### 任务清单

1. **日志工具**
   - [x] 实现 `app/utils/logger.py`（日志工具）
   - [x] 支持 JSON 格式日志
   - [x] 支持文本格式日志
   - [x] 实现日志级别配置
   - [x] 实现日志格式化
   - [x] 支持日志文件输出（可选）

2. **ID 生成器**
   - [x] 实现 `app/utils/id_generator.py`（ID 生成器）
   - [x] 实现通用 ID 生成方法
   - [x] 支持自定义前缀
   - [x] 支持时间戳 + UUID 组合

3. **其他工具类（可选）**
   - [x] 实现 `app/utils/response.py`（统一响应格式）
   - [x] 实现 `app/utils/exceptions.py`（自定义异常类）

#### 验收标准

- [x] 日志可以正常输出
- [x] 日志格式正确（JSON/文本）
- [x] ID 生成器可以正常生成唯一ID
- [x] 工具类有完整的类型提示和文档

#### 测试验证

```python
# 测试日志
from app.utils.logger import logger

logger.info("测试日志输出")
logger.error("测试错误日志")

# 测试 ID 生成器
from app.utils.id_generator import generate_id

id1 = generate_id("msg")
id2 = generate_id("msg")
assert id1 != id2
assert id1.startswith("msg_")
```

---

### 里程碑 5：依赖注入模块（1 天）

**目标**：完成依赖注入模块，提供基础依赖注入模式。

#### 任务清单

1. **依赖注入实现**
   - [x] 实现 `app/dependencies.py`（依赖注入）
   - [x] 实现数据库依赖（get_db）
   - [x] 实现认证依赖框架（可扩展）
   - [x] 实现权限检查依赖框架（可扩展）

2. **依赖扩展点**
   - [x] 提供认证依赖扩展接口
   - [x] 提供权限检查依赖扩展接口
   - [x] 提供使用示例

#### 验收标准

- [x] 数据库依赖可以正常使用
- [x] 依赖注入模式正确
- [x] 扩展接口清晰

#### 测试验证

```python
# 测试依赖注入
from fastapi import Depends
from app.dependencies import get_db

def test_dependency(db = Depends(get_db)):
    assert db is not None
    # 测试数据库操作
    pass
```

---

### 里程碑 6：主应用入口（1-2 天）

**目标**：完成 FastAPI 应用的基础配置和入口文件。

#### 任务清单

1. **主应用实现**
   - [x] 实现 `app/main.py`（FastAPI 应用）
   - [x] 配置 FastAPI 应用初始化
   - [x] 配置 CORS 中间件
   - [x] 配置请求日志中间件（可选）
   - [x] 配置异常处理中间件

2. **基础路由**
   - [x] 实现健康检查接口（`/health`）
   - [x] 实现版本信息接口（`/version`，可选）
   - [x] 配置 API 路由注册机制

3. **生命周期事件**
   - [x] 实现启动事件（startup）
   - [x] 实现关闭事件（shutdown）
   - [x] 实现数据库连接初始化

4. **API 文档配置**
   - [x] 配置 Swagger UI
   - [x] 配置 ReDoc
   - [x] 配置 API 文档标题和描述

#### 验收标准

- [x] FastAPI 应用可以正常启动
- [x] 健康检查接口返回正常
- [x] CORS 配置正常
- [x] API 文档可以正常访问

#### 完成情况

- ✅ 已完成主应用实现（`app/main.py`），包括 FastAPI 应用初始化、CORS 中间件、请求日志中间件和异常处理中间件
- ✅ 已完成基础路由实现，包括健康检查接口（`/health`）和版本信息接口（`/version`）
- ✅ 已完成生命周期事件实现，包括启动事件、关闭事件和数据库连接初始化
- ✅ 已完成 API 文档配置，包括 Swagger UI 和 ReDoc 的配置
- ✅ 已完成测试用例编写（`tests/test_main.py`），包含 21 个测试用例，全部通过

#### 测试验证

```bash
# 1. 启动服务
uvicorn app.main:app --reload

# 2. 测试健康检查
curl http://localhost:8000/health


# 3. 访问 API 文档
# 浏览器打开 http://localhost:8000/docs
```

---

### 里程碑 7：可选模块 - Celery（2-3 天）

**目标**：完成 Celery 异步任务模块（可选功能）。

#### 任务清单

1. **Celery 配置**
   - [ ] 实现 `app/tasks/celery_app.py`（Celery 应用配置）
   - [ ] 配置 Redis 作为 Broker
   - [ ] 配置任务序列化
   - [ ] 配置任务超时设置
   - [ ] 配置 Worker 参数

2. **任务基础类**
   - [ ] 实现基础任务类（可选）
   - [ ] 实现任务装饰器（可选）
   - [ ] 提供任务示例

3. **任务监控（可选）**
   - [ ] 配置 Flower（Celery 监控工具）
   - [ ] 提供监控配置说明

#### 验收标准

- [ ] Celery 应用可以正常初始化
- [ ] Celery Worker 可以正常启动
- [ ] 任务可以正常提交和执行
- [ ] 配置文档完整

#### 测试验证

```bash
# 1. 启动 Celery Worker
celery -A app.tasks.celery_app worker --loglevel=info

# 2. 测试任务提交（在 Python 中）
from app.tasks.celery_app import celery_app

@celery_app.task
def test_task(message):
    return f"Task received: {message}"

result = test_task.delay("Hello")
print(result.get())
```

---

### 里程碑 8：可选模块 - WebSocket（2-3 天）

**目标**：完成 WebSocket 基础模块（可选功能）。

#### 任务清单

1. **WebSocket 管理器**
   - [ ] 实现 `app/websocket/manager.py`（连接管理器）
   - [ ] 实现连接管理（connect, disconnect）
   - [ ] 实现消息推送（send_personal_message, broadcast）
   - [ ] 实现连接状态跟踪

2. **WebSocket 基础处理器**
   - [ ] 实现 `app/websocket/handler.py`（基础处理器）
   - [ ] 实现连接处理框架
   - [ ] 实现消息接收框架
   - [ ] 提供扩展接口

3. **WebSocket 路由集成**
   - [ ] 在 `app/main.py` 中集成 WebSocket 路由示例
   - [ ] 提供 WebSocket 使用示例

#### 验收标准

- [ ] WebSocket 连接可以正常建立
- [ ] 消息推送功能正常
- [ ] 连接管理正常
- [ ] 使用示例清晰

#### 测试验证

```javascript
// 测试 WebSocket
const ws = new WebSocket('ws://localhost:8000/ws/test_user');

ws.onopen = () => {
  console.log('Connected');
};

ws.onmessage = (event) => {
  console.log('Received:', JSON.parse(event.data));
};

ws.onerror = (error) => {
  console.error('Error:', error);
};
```

---

### 里程碑 9：Repository 基础类（可选，1-2 天）

**目标**：完成 Repository 基础类（可选功能）。

#### 任务清单

1. **Repository 基础类**
   - [ ] 实现 `app/repositories/base.py`（基础 Repository 类）
   - [ ] 实现基础 CRUD 操作
   - [ ] 实现分页查询
   - [ ] 实现通用查询方法

2. **Repository 使用示例**
   - [ ] 提供 Repository 使用示例
   - [ ] 提供继承示例

#### 验收标准

- [ ] Repository 基础类可以正常使用
- [ ] CRUD 操作正常
- [ ] 分页查询正常
- [ ] 使用示例清晰

---

### 里程碑 10：测试配置和文档（2-3 天）

**目标**：完成测试配置、示例代码和完整文档。

#### 任务清单

1. **测试配置**
   - [ ] 配置 `tests/conftest.py`（pytest 配置）
   - [ ] 实现测试数据库配置
   - [ ] 实现测试 Fixture（db_session, client 等）
   - [ ] 创建测试示例文件

2. **示例代码**
   - [ ] 创建 API 路由示例
   - [ ] 创建 Service 示例
   - [ ] 创建 Model 示例
   - [ ] 创建 Repository 示例
   - [ ] 创建 Schema 示例

3. **文档完善**
   - [ ] 完善 `README.md`（使用说明）
   - [ ] 创建 `docs/` 目录（可选）
   - [ ] 编写快速开始指南
   - [ ] 编写配置说明文档
   - [ ] 编写模块使用文档
   - [ ] 编写常见问题文档

4. **项目生成工具（可选）**
   - [ ] 创建 CookieCutter 模板（可选）
   - [ ] 或创建 Python 脚本生成项目（可选）

#### 验收标准

- [ ] 测试配置完整
- [ ] 示例代码清晰
- [ ] 文档完整易懂
- [ ] 可以快速创建新项目

---

## 四、开发顺序建议

### 4.1 推荐开发顺序

```
里程碑 1 → 里程碑 2 → 里程碑 3 → 里程碑 4 → 里程碑 5 → 里程碑 6 → 里程碑 10
                                                                      ↓
                                                            里程碑 7（可选）
                                                            里程碑 8（可选）
                                                            里程碑 9（可选）
```

### 4.2 并行开发建议

- **里程碑 4 和里程碑 5**：可以部分并行（工具类和依赖注入相对独立）
- **里程碑 7、8、9**：完全独立，可以并行开发

---

## 五、每个里程碑的交付物

### 5.1 代码交付物

- 源代码文件
- 配置文件
- 测试文件
- 示例代码

### 5.2 文档交付物

- 代码注释
- README 文档
- 使用说明文档
- 配置说明文档

---

## 六、脚手架模块清单

### 6.1 核心模块（必须）

| 模块 | 文件路径 | 说明 |
|------|----------|------|
| 配置管理 | `app/config.py` | 环境变量、配置验证 |
| 数据库连接 | `app/db/database.py` | SQLAlchemy 连接配置 |
| 基础模型 | `app/db/base.py` | BaseModel（id, created_at, updated_at） |
| 会话管理 | `app/db/session.py` | 数据库会话管理 |
| 日志工具 | `app/utils/logger.py` | 日志配置和格式化 |
| ID 生成器 | `app/utils/id_generator.py` | 通用ID生成方法 |
| 依赖注入 | `app/dependencies.py` | 基础依赖注入模式 |
| 主应用入口 | `app/main.py` | FastAPI 应用配置 |
| Alembic 配置 | `alembic/env.py` | 数据库迁移配置 |

### 6.2 可选模块

| 模块 | 文件路径 | 说明 | 适用场景 |
|------|----------|------|----------|
| Celery 配置 | `app/tasks/celery_app.py` | 异步任务队列 | 需要异步任务处理 |
| WebSocket 管理器 | `app/websocket/manager.py` | WebSocket 连接管理 | 需要实时通信 |
| Repository 基础类 | `app/repositories/base.py` | Repository 模式基础类 | 使用 Repository 模式 |

---

## 七、脚手架使用方式

### 7.1 方式一：Git Clone + 自定义

```bash
# 1. Clone 脚手架仓库
git clone https://github.com/your-org/gd25-arch-backend-python my-project

# 2. 删除 .git，重新初始化
cd my-project
rm -rf .git
git init

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 5. 开始开发
```

### 7.2 方式二：脚本生成（未来实现）

```bash
# 使用脚本生成项目
python generate_project.py \
  --project-name my-project \
  --include-celery \
  --include-websocket \
  --database postgresql
```

### 7.3 方式三：CookieCutter 模板（未来实现）

```bash
# 使用 CookieCutter 模板
cookiecutter https://github.com/your-org/gd25-arch-backend-python-template
```

---

## 八、验收标准总结

### 8.1 功能验收

- [ ] 所有核心模块正常工作
- [ ] 配置管理正常
- [ ] 数据库连接正常
- [ ] 日志输出正常
- [ ] 健康检查接口正常
- [ ] API 文档可以正常访问

### 8.2 可选功能验收

- [ ] Celery 模块正常工作（如果包含）
- [ ] WebSocket 模块正常工作（如果包含）
- [ ] Repository 基础类正常工作（如果包含）

### 8.3 文档验收

- [ ] README 文档完整
- [ ] 使用说明清晰
- [ ] 示例代码可用
- [ ] 配置说明完整

### 8.4 质量验收

- [ ] 代码注释完整
- [ ] 类型提示完整
- [ ] 代码风格统一
- [ ] 无严重 Bug

---

## 九、风险控制

### 9.1 技术风险

- **配置复杂性**：保持配置简洁，提供清晰的文档
- **数据库兼容性**：支持 PostgreSQL 和 MySQL
- **版本兼容性**：明确依赖版本，避免版本冲突

### 9.2 进度风险

- **功能范围扩大**：严格控制功能范围，只包含通用功能
- **文档不完善**：每个里程碑都要完善文档

---

## 十、开发环境要求

### 10.1 必需环境

- Python 3.10+
- PostgreSQL 14+ 或 MySQL 8.0+（用于测试）
- Redis 6.0+（如果包含 Celery 模块）
- Git

### 10.2 开发工具

- IDE：VS Code / PyCharm
- 数据库管理工具：DBeaver / pgAdmin
- API 测试工具：Postman / curl

---

## 十一、后续优化方向

### 11.1 功能增强

- 添加认证模块（JWT）
- 添加权限管理模块
- 添加缓存模块（Redis）
- 添加消息队列模块（RabbitMQ）
- 添加监控模块（Prometheus）

### 11.2 工具增强

- 完善项目生成工具
- 添加代码生成工具
- 添加部署脚本

---

**文档版本**：v1.0  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27

