# FastAPI 后端脚手架 - 开发计划

## 一、项目概述

### 1.1 项目目标

开发一个通用的 FastAPI 后端脚手架，为团队提供标准化的项目基础框架，包含：
- 标准化的项目结构
- 通用的基础设施代码
- 最佳实践和约定
- 可复用的工具类

### 1.2 核心价值

- ✅ **快速启动新项目**：避免重复搭建基础框架
- ✅ **统一代码风格**：团队使用相同的项目结构
- ✅ **减少重复工作**：基础设施代码一次编写，多次使用
- ✅ **提高开发效率**：专注于业务逻辑，而不是基础设施

### 1.3 技术栈

```
技术栈：
├── FastAPI              # Web 框架
├── SQLAlchemy           # ORM 框架
├── Alembic              # 数据库迁移
├── Pydantic             # 数据验证
├── Celery               # 异步任务队列（可选）
├── Redis                # 缓存和消息队列（可选）
└── PostgreSQL/MySQL     # 数据库支持
```

---

## 二、开发原则

### 2.1 设计原则

- **通用性优先**：只包含通用的基础设施代码
- **业务无关**：不包含任何业务逻辑
- **可扩展性**：提供扩展点，允许项目自定义
- **可选模块**：通过参数控制是否包含可选功能

### 2.2 代码规范

- 使用详细的简体中文注释和文档字符串
- 函数和类必须有完整的类型提示
- 异常处理要完善，提供有用的错误信息
- 遵循 PEP 8 代码风格

---

## 三、里程碑划分

### 里程碑 1：项目基础结构（2-3 天）

**目标**：完成项目基础结构搭建，包括目录结构、配置文件、基础依赖等。

#### 任务清单

1. **项目初始化**
   - [x] 创建项目目录结构
   - [x] 初始化 Git 仓库（已存在）
   - [x] 创建 `requirements.txt` 和 `requirements-dev.txt`
   - [x] 创建 `.env.example`
   - [x] 创建 `.gitignore`
   - [x] 创建 `README.md`（使用说明）

2. **基础目录结构**
   - [x] 创建 `app/` 目录结构
   - [x] 创建 `app/api/` 目录（空结构）
   - [x] 创建 `app/services/` 目录（空结构）
   - [x] 创建 `app/models/` 目录（空结构）
   - [x] 创建 `app/schemas/` 目录（空结构）
   - [x] 创建 `app/repositories/` 目录（空结构）
   - [x] 创建 `app/db/` 目录
   - [x] 创建 `app/utils/` 目录
   - [x] 创建 `tests/` 目录

3. **基础配置文件**
   - [x] 创建 `pytest.ini`（测试配置）
   - [x] 创建 `alembic.ini`（数据库迁移配置）
   - [x] 创建 `pyproject.toml`（可选，用于项目元数据）

#### 验收标准

- [x] 项目目录结构完整
- [x] 所有配置文件创建完成
- [x] Git 仓库初始化完成
- [x] README 文档包含使用说明

---

### 里程碑 2：配置管理模块（1-2 天）

**目标**：完成配置管理模块，支持环境变量管理和配置验证。

#### 任务清单

1. **配置管理实现**
   - [x] 实现 `app/config.py`（配置管理）
   - [x] 使用 Pydantic Settings 进行配置验证
   - [x] 支持环境变量读取
   - [x] 支持 `.env` 文件加载
   - [x] 实现多环境配置（开发/测试/生产）

2. **配置项定义**
   - [x] 应用配置（app_name, app_version, debug）
   - [x] 数据库配置（database_url）
   - [x] Redis 配置（redis_url，可选）
   - [x] Celery 配置（celery_broker_url, celery_result_backend，可选）
   - [x] 日志配置（log_level, log_format）
   - [x] CORS 配置（cors_origins）

3. **配置扩展点**
   - [x] 提供配置扩展机制，允许项目添加自定义配置项
   - [x] 实现配置验证逻辑

#### 验收标准

- [x] 配置可以正常加载
- [x] 环境变量可以正常读取
- [x] 配置验证正常工作
- [x] 支持配置扩展

#### 测试验证

```python
# 测试配置加载
from app.config import settings

assert settings.app_name is not None
assert settings.database_url is not None
print(f"App name: {settings.app_name}")
print(f"Database URL: {settings.database_url}")
```

---

### 里程碑 3：数据库基础模块（2-3 天）

**目标**：完成数据库连接、基础模型、会话管理等基础功能。

#### 任务清单

1. **数据库连接**
   - [x] 实现 `app/db/database.py`（数据库连接）
   - [x] 配置 SQLAlchemy Engine
   - [x] 配置连接池（pool_size, max_overflow）
   - [x] 实现连接健康检查（pool_pre_ping）

2. **基础模型**
   - [x] 实现 `app/db/base.py`（基础模型类）
   - [x] 定义 BaseModel（包含 id, created_at, updated_at）
   - [x] 实现 DeclarativeBase

3. **会话管理**
   - [x] 实现 `app/db/session.py`（会话管理）
   - [x] 实现 SessionLocal（sessionmaker）
   - [x] 实现 `get_db()` 依赖注入函数
   - [x] 实现数据库会话上下文管理

4. **Alembic 配置**
   - [x] 配置 `alembic/env.py`
   - [x] 配置数据库迁移脚本模板
   - [x] 创建初始迁移脚本示例（README 和目录结构）

#### 验收标准

- [x] 数据库连接正常
- [x] 基础模型可以正常使用
- [x] 数据库会话管理正常
- [x] Alembic 配置完成

#### 测试验证

```python
# 测试数据库连接
from app.db.database import engine, SessionLocal
from app.db.base import Base

# 测试连接
with engine.connect() as conn:
    result = conn.execute(text("SELECT 1"))
    assert result.scalar() == 1

# 测试会话
db = SessionLocal()
try:
    # 测试查询
    result = db.execute(text("SELECT 1"))
    assert result.scalar() == 1
finally:
    db.close()
```

---

### 里程碑 4：工具类模块（1-2 天）

**目标**：完成日志工具、ID 生成器等通用工具类。

#### 任务清单

1. **日志工具**
   - [x] 实现 `app/utils/logger.py`（日志工具）
   - [x] 支持 JSON 格式日志
   - [x] 支持文本格式日志
   - [x] 实现日志级别配置
   - [x] 实现日志格式化
   - [x] 支持日志文件输出（可选）

2. **ID 生成器**
   - [x] 实现 `app/utils/id_generator.py`（ID 生成器）
   - [x] 实现通用 ID 生成方法
   - [x] 支持自定义前缀
   - [x] 支持时间戳 + UUID 组合

3. **其他工具类（可选）**
   - [x] 实现 `app/utils/response.py`（统一响应格式）
   - [x] 实现 `app/utils/exceptions.py`（自定义异常类）

#### 验收标准

- [x] 日志可以正常输出
- [x] 日志格式正确（JSON/文本）
- [x] ID 生成器可以正常生成唯一ID
- [x] 工具类有完整的类型提示和文档

#### 测试验证

```python
# 测试日志
from app.utils.logger import logger

logger.info("测试日志输出")
logger.error("测试错误日志")

# 测试 ID 生成器
from app.utils.id_generator import generate_id

id1 = generate_id("msg")
id2 = generate_id("msg")
assert id1 != id2
assert id1.startswith("msg_")
```

---

### 里程碑 5：依赖注入模块（1 天）

**目标**：完成依赖注入模块，提供基础依赖注入模式。

#### 任务清单

1. **依赖注入实现**
   - [x] 实现 `app/dependencies.py`（依赖注入）
   - [x] 实现数据库依赖（get_db）
   - [x] 实现认证依赖框架（可扩展）
   - [x] 实现权限检查依赖框架（可扩展）

2. **依赖扩展点**
   - [x] 提供认证依赖扩展接口
   - [x] 提供权限检查依赖扩展接口
   - [x] 提供使用示例

#### 验收标准

- [x] 数据库依赖可以正常使用
- [x] 依赖注入模式正确
- [x] 扩展接口清晰

#### 测试验证

```python
# 测试依赖注入
from fastapi import Depends
from app.dependencies import get_db

def test_dependency(db = Depends(get_db)):
    assert db is not None
    # 测试数据库操作
    pass
```

---

### 里程碑 6：主应用入口（1-2 天）

**目标**：完成 FastAPI 应用的基础配置和入口文件。

#### 任务清单

1. **主应用实现**
   - [x] 实现 `app/main.py`（FastAPI 应用）
   - [x] 配置 FastAPI 应用初始化
   - [x] 配置 CORS 中间件
   - [x] 配置请求日志中间件（可选）
   - [x] 配置异常处理中间件

2. **基础路由**
   - [x] 实现健康检查接口（`/health`）
   - [x] 实现版本信息接口（`/version`，可选）
   - [x] 配置 API 路由注册机制

3. **生命周期事件**
   - [x] 实现启动事件（startup）
   - [x] 实现关闭事件（shutdown）
   - [x] 实现数据库连接初始化

4. **API 文档配置**
   - [x] 配置 Swagger UI
   - [x] 配置 ReDoc
   - [x] 配置 API 文档标题和描述

#### 验收标准

- [x] FastAPI 应用可以正常启动
- [x] 健康检查接口返回正常
- [x] CORS 配置正常
- [x] API 文档可以正常访问

#### 完成情况

- ✅ 已完成主应用实现（`app/main.py`），包括 FastAPI 应用初始化、CORS 中间件、请求日志中间件和异常处理中间件
- ✅ 已完成基础路由实现，包括健康检查接口（`/health`）和版本信息接口（`/version`）
- ✅ 已完成生命周期事件实现，包括启动事件、关闭事件和数据库连接初始化
- ✅ 已完成 API 文档配置，包括 Swagger UI 和 ReDoc 的配置
- ✅ 已完成测试用例编写（`tests/test_main.py`），包含 21 个测试用例，全部通过

#### 测试验证

```bash
# 1. 启动服务
uvicorn app.main:app --reload

# 2. 测试健康检查
curl http://localhost:8000/health


# 3. 访问 API 文档
# 浏览器打开 http://localhost:8000/docs
```

---

### 里程碑 7：可选模块 - Celery（2-3 天）

**目标**：完成 Celery 异步任务模块（可选功能）。

#### 任务清单

1. **Celery 配置**
   - [x] 实现 `app/tasks/celery_app.py`（Celery 应用配置）
   - [x] 配置 RabbitMQ 作为 Broker（使用 amqp://admin:admin123@localhost:5672/）
   - [x] 配置任务序列化
   - [x] 配置任务超时设置
   - [x] 配置 Worker 参数
   - [x] 在 `app/config.py` 中添加 RabbitMQ 配置项（可选，用于统一管理）

2. **任务基础类**
   - [x] 实现基础任务类（可选）
   - [x] 实现任务装饰器（可选）
   - [x] 提供任务示例

3. **任务监控（可选）**
   - [x] 配置 Flower（Celery 监控工具）
   - [x] 提供监控配置说明

#### 验收标准

- [x] Celery 应用可以正常初始化
- [x] Celery Worker 可以正常启动
- [x] 任务可以正常提交和执行
- [x] 配置文档完整

#### 完成情况

- ✅ 已完成 Celery 应用配置（`app/tasks/celery_app.py`），包括：
  - RabbitMQ 作为 Broker 的配置
  - 任务序列化配置（JSON）
  - 任务超时设置（软超时 300 秒，硬超时 600 秒）
  - Worker 参数配置（预取数量、最大任务数等）
  - 任务信号处理（执行前、执行后、失败时）
  - 任务路由配置框架
- ✅ 已完成基础任务类实现（`app/tasks/base.py`），包括：
  - `BaseTask` 基础任务类，提供成功、失败、重试回调
  - `@task` 装饰器，简化任务定义
- ✅ 已完成任务示例（`app/tasks/examples.py`），包括：
  - 简单任务示例
  - 使用装饰器的任务示例
  - 可重试任务示例
  - 长时间运行的任务示例
  - 链式任务示例
- ✅ 已完成依赖更新（`requirements.txt`），取消注释 Celery 依赖
- ✅ 已完成测试用例编写（`tests/test_celery.py`），包含 20+ 个测试用例，覆盖：
  - Celery 应用初始化和配置
  - 基础任务类功能
  - 任务装饰器
  - 任务定义和配置
  - 任务执行（使用 EAGER 模式）
  - 错误处理
- ✅ 已完成 Flower 监控配置，包括：
  - 在 `requirements.txt` 中添加 Flower 依赖（可选）
  - 在 `app/config.py` 中添加 Flower 配置项（端口、基本认证、URL 前缀）
  - 创建 Flower 启动脚本（`scripts/start_flower.sh`）
  - 编写完整的监控配置说明文档（`docs/边做边学/flower监控配置说明.md`），包括：
    - 安装说明
    - 配置说明（环境变量、基本认证、URL 前缀）
    - 启动方式（脚本、命令行、Python 代码）
    - 功能说明（Dashboard、Workers、Tasks、监控等）
    - 生产环境配置建议（认证、反向代理、系统服务）
    - 常见问题解答
    - 与 Celery Worker 配合使用说明

#### 测试验证

```bash
# 1. 确保 RabbitMQ 容器已启动
docker start rabbitmq-gd25
# 或检查容器状态
docker ps | grep rabbitmq-gd25

# 2. 验证 RabbitMQ 连接（可选）
# 访问 Web 管理界面：http://localhost:15672
# 用户名：admin，密码：admin123

# 3. 启动 Celery Worker
celery -A app.tasks.celery_app worker --loglevel=info

# 4. 测试任务提交（在 Python 中）
from app.tasks.celery_app import celery_app

@celery_app.task
def test_task(message):
    return f"Task received: {message}"

result = test_task.delay("Hello")
print(result.get())
```

#### 环境变量配置

在 `.env` 文件中配置 RabbitMQ 连接：

```bash
# RabbitMQ 配置（Celery Broker）
CELERY_BROKER_URL=amqp://admin:admin123@localhost:5672/

# Result Backend（可选，可以使用 Redis 或 RabbitMQ）
# 如果使用 Redis：
CELERY_RESULT_BACKEND=redis://localhost:6379/0
# 如果使用 RabbitMQ：
# CELERY_RESULT_BACKEND=rpc://

# 注意：如果不配置 CELERY_RESULT_BACKEND：
# - Celery 不会自动使用 Broker（RabbitMQ）作为 Result Backend
# - 任务可以正常执行，但无法获取任务结果（result.get() 会失败）
# - 适用于不需要返回值的任务（fire-and-forget 模式）
# - 如果需要获取任务结果，必须显式配置 Result Backend
```

#### 注意事项

- **RabbitMQ URL 格式**：`amqp://user:password@host:port/vhost`
  - 默认 vhost 是 `/`，URL 末尾的 `/` 不能省略
  - 示例：`amqp://admin:admin123@localhost:5672/`
- **容器管理**：使用 `docker start rabbitmq-gd25` 启动容器，不要自己创建新的 docker-compose.yml
- **端口说明**：
  - `5672`：AMQP 协议端口（Celery 使用）
  - `15672`：Web 管理界面端口
- **依赖说明**：Celery 已内置 RabbitMQ 支持（通过 kombu），无需额外安装 RabbitMQ 客户端库
- **Result Backend 说明**：
  - **不配置 Result Backend**：任务可以正常执行，但无法获取返回值（`result.get()` 会失败）
  - **不会自动使用 Broker**：Celery 不会自动将 RabbitMQ Broker 作为 Result Backend
  - **使用 RabbitMQ 作为 Result Backend**：需要显式配置 `CELERY_RESULT_BACKEND=rpc://`
  - **推荐方案**：使用 Redis 作为 Result Backend（性能更好），RabbitMQ 仅作为 Broker

---

### 里程碑 8：可选模块 - WebSocket（2-3 天）

**目标**：完成 WebSocket 基础模块（可选功能）。

#### 任务清单

1. **WebSocket 管理器**
   - [x] 实现 `app/websocket/manager.py`（连接管理器）
   - [x] 实现连接管理（connect, disconnect）
   - [x] 实现消息推送（send_personal_message, broadcast）
   - [x] 实现连接状态跟踪

2. **WebSocket 基础处理器**
   - [x] 实现 `app/websocket/handler.py`（基础处理器）
   - [x] 实现连接处理框架
   - [x] 实现消息接收框架
   - [x] 提供扩展接口

3. **WebSocket 路由集成**
   - [x] 在 `app/main.py` 中集成 WebSocket 路由示例
   - [x] 提供 WebSocket 使用示例

#### 验收标准

- [x] WebSocket 连接可以正常建立
- [x] 消息推送功能正常
- [x] 连接管理正常
- [x] 使用示例清晰

#### 测试验证

**测试方法：**

1. **浏览器控制台测试（最简单）**
   ```javascript
   // 测试 WebSocket
   const ws = new WebSocket('ws://localhost:8000/ws/test_user');
   
   ws.onopen = () => {
     console.log('Connected');
   };
   
   ws.onmessage = (event) => {
     console.log('Received:', JSON.parse(event.data));
   };
   
   ws.onerror = (error) => {
     console.error('Error:', error);
   };
   ```

2. **HTML 测试页面**
   - 打开 `tests/websocket_test.html` 在浏览器中测试
   - 提供图形化界面，方便测试各种功能

3. **Python 单元测试**
   ```bash
   # 运行 WebSocket 测试
   pytest tests/test_websocket.py -v
   ```

4. **详细测试说明**
   - 查看 `docs/边做边学/websocket测试说明.md` 获取完整的测试指南

---

### 里程碑 9：Repository 基础类（可选，1-2 天）

**目标**：完成 Repository 基础类（可选功能）。

#### 任务清单

1. **Repository 基础类**
   - [x] 实现 `app/repositories/base.py`（基础 Repository 类）
   - [x] 实现基础 CRUD 操作
   - [x] 实现分页查询
   - [x] 实现通用查询方法

2. **Repository 使用示例**
   - [x] 提供 Repository 使用示例
   - [x] 提供继承示例

#### 验收标准

- [x] Repository 基础类可以正常使用
- [x] CRUD 操作正常
- [x] 分页查询正常
- [x] 使用示例清晰

#### 完成情况

**已完成内容：**

1. **Repository 基础类实现** (`app/repositories/base.py`)
   - ✅ 实现了 `BaseRepository` 泛型基类，支持任意继承自 `BaseModel` 的模型
   - ✅ 实现了 `PaginationParams` 和 `PaginationResult` 类，用于分页查询
   - ✅ 实现了完整的 CRUD 操作：
     - Create: `create()`, `create_many()`
     - Read: `get_by_id()`, `get_all()`, `get_count()`, `exists()`
     - Update: `update()`, `update_or_create()`
     - Delete: `delete()`, `delete_many()`, `delete_all()`
   - ✅ 实现了分页查询：`paginate()` 方法，支持排序
   - ✅ 实现了通用查询方法：
     - `filter_by()`: 条件过滤
     - `filter_one()`: 单条记录查询
     - `filter_by_dict()`: 字典条件过滤
     - `search()`: 关键字搜索（模糊匹配）
     - `query_builder()`: 查询构建器，支持复杂查询

2. **Repository 使用示例** (`docs/边做边学/repository使用示例.md`)
   - ✅ 提供了完整的使用文档，包括：
     - 基础用法示例
     - 继承示例（如何扩展 Repository）
     - CRUD 操作示例
     - 分页查询示例
     - 通用查询示例
     - 在 FastAPI 中使用示例
     - 完整示例代码

3. **模块导出** (`app/repositories/__init__.py`)
   - ✅ 正确导出了所有必要的类和类型

**技术特点：**

- 使用泛型类型，提供类型安全
- 完整的类型提示
- 详细的简体中文注释和文档字符串
- 完善的异常处理（IntegrityError）
- 支持批量操作，提高性能
- 灵活的分页和查询功能
- 支持自定义扩展

**使用方式：**

```python
from app.repositories.base import BaseRepository
from sqlalchemy.orm import Session
from app.models.user import User

class UserRepository(BaseRepository[User]):
    def __init__(self, db: Session):
        super().__init__(User, db)

# 使用
user_repo = UserRepository(db)
user = user_repo.create({"name": "张三", "email": "zhangsan@example.com"})
result = user_repo.paginate(page=1, page_size=10)
```

---

### 里程碑 10：测试配置和文档（2-3 天）

**目标**：完成测试配置、示例代码和完整文档。

#### 任务清单

1. **测试配置**
   - [x] 配置 `tests/conftest.py`（pytest 配置）
   - [x] 实现测试数据库配置
   - [x] 实现测试 Fixture（db_session, client 等）
   - [x] 创建测试示例文件
   - [x] 修正测试文件命名：`test_setting.py` → `test_config.py`

2. **示例代码**
   - [x] 创建 API 路由示例（`app/api/users.py`）
   - [x] 创建 Service 示例（`app/services/user_service.py`）
   - [x] 创建 Model 示例（`app/models/user.py`）
   - [x] 创建 Repository 示例（`app/repositories/user_repository.py`）
   - [x] 创建 Schema 示例（`app/schemas/user.py`）

3. **文档完善**
   - [x] 完善 `README.md`（使用说明、示例代码链接）
   - [x] 创建 `docs/` 目录（已存在）
   - [x] 编写快速开始指南（`docs/边做边学/快速开始指南.md`）
   - [x] 编写配置说明文档（已在 README 和代码注释中）
   - [x] 编写模块使用文档（`docs/边做边学/示例代码使用说明.md`）
   - [ ] 编写常见问题文档（可选，已在快速开始指南中包含）

4. **项目生成工具（可选）**
   - [ ] 创建 CookieCutter 模板（可选，未来实现）
   - [ ] 或创建 Python 脚本生成项目（可选，未来实现）

#### 验收标准

- [x] 测试配置完整
  - ✅ 已创建 `tests/conftest.py`，包含测试数据库配置和共享 fixture
  - ✅ 已修正测试文件命名规则（`test_setting.py` → `test_config.py`）
  - ✅ 测试 fixture 包括：`db_session`、`client`、`authenticated_client`、`sample_user_data` 等
- [x] 示例代码清晰
  - ✅ 已创建完整的用户管理示例（Model、Schema、Repository、Service、API）
  - ✅ 示例代码包含详细的中文注释和文档字符串
  - ✅ 示例代码展示了完整的分层架构
- [x] 文档完整易懂
  - ✅ 已更新 README.md，添加示例代码和快速开始指南链接
  - ✅ 已创建快速开始指南（`docs/边做边学/快速开始指南.md`）
  - ✅ 已创建示例代码使用说明（`docs/边做边学/示例代码使用说明.md`）
  - ✅ 文档包含使用步骤、API 端点说明、自定义扩展指南等
- [x] 可以快速创建新项目
  - ✅ 快速开始指南提供了 5 步快速启动流程
  - ✅ 示例代码可以直接使用和参考
  - ✅ 文档完整，易于理解

#### 完成情况

**已完成内容：**

1. **测试配置** (`tests/conftest.py`)
   - ✅ 实现了测试数据库配置（使用 SQLite 内存数据库）
   - ✅ 实现了测试 Fixture：
     - `test_engine`：测试数据库引擎（会话级别）
     - `db_session`：测试数据库会话（函数级别，自动回滚）
     - `client`：FastAPI 测试客户端
     - `authenticated_client`：已认证的测试客户端（框架）
     - `sample_user_data`：示例用户数据
     - `sample_users_data`：示例用户列表数据
     - `mock_settings`：Mock 配置对象
   - ✅ 实现了数据库操作辅助函数：`cleanup_database`、`reset_database`
   - ✅ 配置了 pytest 标记和测试钩子

2. **测试文件命名修正**
   - ✅ 将 `test_setting.py` 重命名为 `test_config.py`（符合配置模块命名）
   - ✅ 完善了 `test_config.py`，添加了完整的配置测试用例

3. **示例代码**
   - ✅ **Model 示例** (`app/models/user.py`)：用户模型，展示如何使用 BaseModel
   - ✅ **Schema 示例** (`app/schemas/user.py`)：用户 Schema，包含创建、更新、响应等不同场景
   - ✅ **Repository 示例** (`app/repositories/user_repository.py`)：用户 Repository，展示如何继承 BaseRepository 并添加自定义方法
   - ✅ **Service 示例** (`app/services/user_service.py`)：用户服务，展示业务逻辑处理和验证
   - ✅ **API 示例** (`app/api/users.py`)：用户 API 路由，包含完整的 CRUD 操作和分页、搜索功能

4. **文档完善**
   - ✅ 更新了 `README.md`，添加了示例代码和快速开始指南的链接
   - ✅ 创建了 `docs/边做边学/快速开始指南.md`，包含：
     - 5 步快速启动流程
     - 下一步：使用示例代码
     - 开发第一个功能的完整示例
     - 常用命令
     - 项目结构说明
     - 常见问题解答
   - ✅ 创建了 `docs/边做边学/示例代码使用说明.md`，包含：
     - 示例代码概述和结构
     - 使用步骤
     - 示例代码详解（每层的说明）
     - API 端点说明
     - 自定义扩展指南
     - 最佳实践和注意事项

**技术特点：**

- 测试配置使用 SQLite 内存数据库，无需配置实际数据库即可运行测试
- 测试 Fixture 自动管理数据库会话生命周期，确保测试数据隔离
- 示例代码展示了完整的分层架构（Model → Schema → Repository → Service → API）
- 示例代码包含详细的中文注释和文档字符串
- 文档结构清晰，易于理解和参考

**使用方式：**

1. **使用示例代码**：
   ```python
   # 在 app/main.py 中注册路由
   from app.api.users import router as users_router
   app.include_router(users_router, prefix="/api/v1")
   ```

2. **运行测试**：
   ```bash
   pytest  # 使用 conftest.py 中的 fixture
   ```

3. **参考文档**：
   - 快速开始：`docs/边做边学/快速开始指南.md`
   - 示例代码：`docs/边做边学/示例代码使用说明.md`

---

### 里程碑 11：CookieCutter 模板支持（2-3 天）

**目标**：将脚手架转换为 CookieCutter 模板，支持通过模板快速生成新项目。

#### 任务清单

1. **CookieCutter 模板结构设计**
   - [ ] 创建 `cookiecutter.json` 配置文件，定义模板变量
   - [ ] 设计模板变量（项目名称、描述、作者、版本等）
   - [ ] 设计可选模块变量（是否包含 Celery、WebSocket 等）
   - [ ] 创建模板目录结构 `{{ cookiecutter.project_name }}/`

2. **模板文件转换**
   - [ ] 将项目文件转换为模板文件（使用 `{{ cookiecutter.variable }}` 替换）
   - [ ] 替换 `pyproject.toml` 中的项目名称、描述、作者等信息
   - [ ] 替换 `README.md` 中的项目名称和描述
   - [ ] 替换 `app/config.py` 中的默认应用名称（如果硬编码）
   - [ ] 替换所有文档中的项目名称引用

3. **可选模块条件处理**
   - [ ] 实现条件文件包含（根据 `include_celery` 变量）
   - [ ] 实现条件文件包含（根据 `include_websocket` 变量）
   - [ ] 在 `requirements.txt` 中使用条件注释（CookieCutter 后处理）
   - [ ] 在 `app/main.py` 中使用条件导入（根据变量）

4. **模板测试和验证**
   - [ ] 创建测试脚本，验证模板生成的项目可以正常运行
   - [ ] 测试不同配置组合（包含/不包含可选模块）
   - [ ] 验证生成的项目结构正确
   - [ ] 验证生成的项目可以正常启动

5. **文档完善**
   - [ ] 更新 `README.md`，添加 CookieCutter 使用说明
   - [ ] 创建 CookieCutter 使用指南（`docs/边做边学/CookieCutter使用指南.md`）
   - [ ] 更新项目评估报告，标记 CookieCutter 支持已完成

#### 验收标准

- [ ] CookieCutter 模板可以正常生成项目
- [ ] 生成的项目可以正常启动
- [ ] 生成的项目结构正确
- [ ] 可选模块条件包含正常工作
- [ ] 文档完整清晰

#### 实施步骤

**步骤 1：创建 CookieCutter 模板结构**

```bash
# 1. 创建模板目录结构
mkdir -p cookiecutter-gd25-arch-backend-python/{{ cookiecutter.project_name }}

# 2. 创建 cookiecutter.json 配置文件
# 定义模板变量，包括：
# - project_name: 项目名称
# - project_description: 项目描述
# - author_name: 作者名称
# - author_email: 作者邮箱
# - python_version: Python 版本
# - include_celery: 是否包含 Celery 模块
# - include_websocket: 是否包含 WebSocket 模块
# - database_type: 数据库类型（postgresql/mysql）
```

**步骤 2：转换项目文件为模板**

需要替换的内容：
- `pyproject.toml`: 项目名称、描述、作者
- `README.md`: 项目名称、描述
- `app/config.py`: 默认应用名称（如果有硬编码）
- 所有文档中的项目名称引用

**步骤 3：处理可选模块**

使用 CookieCutter 的条件文件包含功能：
- 在模板目录中创建条件目录结构
- 使用 `{% if cookiecutter.include_celery == 'y' %}` 等条件判断

**步骤 4：测试模板**

```bash
# 测试模板生成
cookiecutter cookiecutter-gd25-arch-backend-python --no-input

# 验证生成的项目
cd my-new-project
pip install -r requirements.txt
pytest
uvicorn app.main:app --reload
```

#### 技术要点

1. **模板变量命名规范**
   - 使用小写字母和下划线：`project_name`、`author_name`
   - 布尔值使用 'y'/'n' 字符串：`include_celery: 'y'`

2. **条件文件包含**
   - 使用目录名条件：`{% if cookiecutter.include_celery == 'y' %}app/tasks{% endif %}`
   - 使用文件内容条件：在文件中使用 `{% if %}` 标签

3. **文件内容替换**
   - 使用 `{{ cookiecutter.variable }}` 替换变量
   - 使用 `{% if %}` 条件判断
   - 使用 `{% for %}` 循环（如需要）

4. **模板目录结构**
   ```
   cookiecutter-gd25-arch-backend-python/
   ├── cookiecutter.json          # 模板配置
   └── {{ cookiecutter.project_name }}/  # 模板文件目录
       ├── app/
       ├── tests/
       ├── requirements.txt
       ├── README.md
       └── ...
   ```

#### 完成情况

- [ ] 待实施

---

## 四、开发顺序建议

### 4.1 推荐开发顺序

```
里程碑 1 → 里程碑 2 → 里程碑 3 → 里程碑 4 → 里程碑 5 → 里程碑 6 → 里程碑 10
                                                                      ↓
                                                            里程碑 7（可选）
                                                            里程碑 8（可选）
                                                            里程碑 9（可选）
                                                            里程碑 11（可选）
```

### 4.2 并行开发建议

- **里程碑 4 和里程碑 5**：可以部分并行（工具类和依赖注入相对独立）
- **里程碑 7、8、9**：完全独立，可以并行开发

---

## 五、每个里程碑的交付物

### 5.1 代码交付物

- 源代码文件
- 配置文件
- 测试文件
- 示例代码

### 5.2 文档交付物

- 代码注释
- README 文档
- 使用说明文档
- 配置说明文档

---

## 六、脚手架模块清单

### 6.1 核心模块（必须）

| 模块 | 文件路径 | 说明 |
|------|----------|------|
| 配置管理 | `app/config.py` | 环境变量、配置验证 |
| 数据库连接 | `app/db/database.py` | SQLAlchemy 连接配置 |
| 基础模型 | `app/db/base.py` | BaseModel（id, created_at, updated_at） |
| 会话管理 | `app/db/session.py` | 数据库会话管理 |
| 日志工具 | `app/utils/logger.py` | 日志配置和格式化 |
| ID 生成器 | `app/utils/id_generator.py` | 通用ID生成方法 |
| 依赖注入 | `app/dependencies.py` | 基础依赖注入模式 |
| 主应用入口 | `app/main.py` | FastAPI 应用配置 |
| Alembic 配置 | `alembic/env.py` | 数据库迁移配置 |

### 6.2 可选模块

| 模块 | 文件路径 | 说明 | 适用场景 |
|------|----------|------|----------|
| Celery 配置 | `app/tasks/celery_app.py` | 异步任务队列 | 需要异步任务处理 |
| WebSocket 管理器 | `app/websocket/manager.py` | WebSocket 连接管理 | 需要实时通信 |
| Repository 基础类 | `app/repositories/base.py` | Repository 模式基础类 | 使用 Repository 模式 |

---

## 七、脚手架使用方式

### 7.1 方式一：Git Clone + 自定义

```bash
# 1. Clone 脚手架仓库
git clone https://github.com/your-org/gd25-arch-backend-python my-project

# 2. 删除 .git，重新初始化
cd my-project
rm -rf .git
git init

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 5. 开始开发
```

### 7.2 方式二：脚本生成（未来实现）

```bash
# 使用脚本生成项目
python generate_project.py \
  --project-name my-project \
  --include-celery \
  --include-websocket \
  --database postgresql
```

### 7.3 方式三：CookieCutter 模板（实施中）

```bash
# 安装 CookieCutter（如果未安装）
pip install cookiecutter

# 使用 CookieCutter 模板（本地）
cookiecutter cookiecutter-gd25-arch-backend-python

# 使用 CookieCutter 模板（GitHub）
cookiecutter https://github.com/your-org/cookiecutter-gd25-arch-backend-python

# 按提示输入项目信息
# 详细使用说明请参考：docs/边做边学/CookieCutter使用指南.md
```

---

## 八、验收标准总结

### 8.1 功能验收

- [x] 所有核心模块正常工作
  - ✅ 测试通过：21个测试用例全部通过
  - ✅ 核心模块包括：配置管理、数据库、日志、依赖注入、主应用等
- [x] 配置管理正常
  - ✅ 配置可以正常加载和验证
  - ✅ 环境变量可以正常读取
  - ✅ 支持配置扩展
- [x] 数据库连接正常
  - ✅ 数据库连接测试通过
  - ✅ 连接池配置正常
  - ✅ 健康检查接口可以检测数据库状态
- [x] 日志输出正常
  - ✅ 日志可以正常输出（JSON/文本格式）
  - ✅ 日志级别配置正常
  - ✅ 日志格式化正确
- [x] 健康检查接口正常
  - ✅ `/health` 接口返回正常
  - ✅ 包含应用状态和数据库状态信息
  - ✅ 响应格式符合规范
- [x] API 文档可以正常访问
  - ✅ Swagger UI 配置正常（`/docs`）
  - ✅ ReDoc 配置正常（`/redoc`）
  - ✅ OpenAPI JSON 可以正常访问（`/openapi.json`）

### 8.2 可选功能验收

- [x] Celery 模块正常工作（如果包含）
  - ✅ Celery 应用可以正常初始化
  - ✅ 任务定义和配置正常
  - ✅ 测试用例覆盖完整（20+ 个测试用例）
  - ✅ 基础任务类和装饰器正常工作
  - ⚠️ 注意：需要安装 Celery 依赖才能运行（`pip install celery`）
- [x] WebSocket 模块正常工作（如果包含）
  - ✅ WebSocket 连接管理器正常工作
  - ✅ 连接建立和消息推送功能正常
  - ✅ 测试用例覆盖完整
  - ✅ 统计接口正常工作
- [x] Repository 基础类正常工作（如果包含）
  - ✅ Repository 基础类实现完整
  - ✅ CRUD 操作正常
  - ✅ 分页查询功能正常
  - ✅ 通用查询方法正常
  - ✅ 测试用例覆盖完整（30+ 个测试用例）

### 8.3 文档验收

- [x] README 文档完整
  - ✅ 包含项目简介、核心价值、技术栈
  - ✅ 包含快速开始指南
  - ✅ 包含项目结构说明
  - ✅ 包含配置说明和使用方式
- [x] 使用说明清晰
  - ✅ 启动方式说明文档（`docs/边做边学/启动方式说明.md`）
  - ✅ 测试执行说明文档（`docs/边做边学/测试执行说明.md`）
  - ✅ Repository 使用示例文档（`docs/边做边学/repository使用示例.md`）
  - ✅ WebSocket 测试说明文档（`docs/边做边学/websocket测试说明.md`）
  - ✅ WebSocket 基础原理文档（`docs/边做边学/websocket基础原理.md`）
  - ✅ Flower 监控配置说明（`docs/边做边学/flower监控配置说明.md`）
- [x] 示例代码可用
  - ✅ Celery 任务示例（`app/tasks/examples.py`）
  - ✅ Repository 使用示例（文档中包含）
  - ✅ WebSocket 使用示例（文档中包含）
  - ✅ 装饰器示例（`docs/装饰器/decorator_examples.py`）
- [x] 配置说明完整
  - ✅ 环境变量配置说明（`.env.example`）
  - ✅ 配置扩展说明（代码注释中）
  - ✅ 各模块配置说明（文档中）

### 8.4 质量验收

- [x] 代码注释完整
  - ✅ 所有模块都有模块级文档字符串
  - ✅ 所有类和函数都有文档字符串
  - ✅ 使用简体中文注释
  - ✅ 注释说明清晰完整
- [x] 类型提示完整
  - ✅ 函数参数和返回值都有类型提示
  - ✅ 类属性都有类型提示
  - ✅ 使用泛型类型（如 `BaseRepository[ModelType]`）
  - ✅ 类型提示覆盖率高
- [x] 代码风格统一
  - ✅ 遵循 PEP 8 代码风格
  - ✅ 使用统一的命名规范
  - ✅ 代码结构清晰
  - ✅ 异常处理完善
- [x] 无严重 Bug
  - ✅ 核心功能测试全部通过
  - ✅ 未发现严重 Bug
  - ✅ 异常处理完善
  - ⚠️ 注意：Celery 模块需要安装依赖才能运行（这是正常的，因为 Celery 是可选依赖）

---

## 九、风险控制

### 9.1 技术风险

- **配置复杂性**：保持配置简洁，提供清晰的文档
- **数据库兼容性**：支持 PostgreSQL 和 MySQL
- **版本兼容性**：明确依赖版本，避免版本冲突

### 9.2 进度风险

- **功能范围扩大**：严格控制功能范围，只包含通用功能
- **文档不完善**：每个里程碑都要完善文档

---

## 十、开发环境要求

### 10.1 必需环境

- Python 3.10+
- PostgreSQL 14+ 或 MySQL 8.0+（用于测试）
- Redis 6.0+（如果包含 Celery 模块）
- Git

### 10.2 开发工具

- IDE：VS Code / PyCharm
- 数据库管理工具：DBeaver / pgAdmin
- API 测试工具：Postman / curl

---

## 十一、后续优化方向

### 11.1 功能增强

- 添加认证模块（JWT）
- 添加权限管理模块
- 添加缓存模块（Redis）
- 添加消息队列模块（RabbitMQ）
- 添加监控模块（Prometheus）

### 11.2 工具增强

- 完善项目生成工具
- 添加代码生成工具
- 添加部署脚本

---

**文档版本**：v1.0  
**创建时间**：2025-01-27  
**最后更新**：2025-01-27

